#  Building a SOC with Honeypots and Live Traffic Monitoring Using Microsoft Azure Sentinel Attack Map
![WhatsApp Image 2025-01-26 at 4 15 08 PM](https://github.com/user-attachments/assets/4866e6e5-e14f-43b7-b89e-e88eeeeae6b6)


## Introduction
SIEM stands for Security Information and Event Management System. It is a solution that helps organizations detect, analyze, and respond to security threats before they harm business operations. It is a tool that collects event log data from a range of sources within a network such as Firewalls, IDS/IPS, Identity solutions, etc. This allows the security professionals to monitor, prioritize and remediate potential threats in real-time. A honeypot is a security mechanism that creates a virtual trap in a controlled and safe environment to lure attackers. An intentionally compromised computer system to study how attackers work, examine different types of threats and improve security policies. 

In this project, I created a mini honeynet in Microsoft Azure to simulate and analyze potential security threats in a controlled cloud environment. I configured various Azure resources to generate and ingest logs into a centralized Log Analytics Workspace. This workspace was integrated with Microsoft Sentinel, a SIEM (Security Information and Event Management) tool, to enable real-time monitoring, visualization of attack patterns, and automated alerting mechanisms.

### Learning Objectives:
- Configuration & Deployment of Azure resources such as virtual machines, Log Analytics Workspaces, and Azure Sentinel
- Hands-on experience and working knowledge of a SIEM Log Management Tool (Microsoft's Azure Sentinel)
- Understand Windows Security Event logs and Syslog
- Utilization of KQL to query logs
- Display attack data on a dashboard with Workbooks (World Map)

To evaluate the environment's security posture, I first measured specific metrics in its default, insecure state over a 24-hour period. Subsequently, I implemented robust security controls to harden the environment and conducted another 24-hour observation to assess the impact of these improvements.

The metrics collected during this process included the following:

- SecurityEvent   (Windows Event Logs)
- Syslog                      (Linux Event Logs)
- SecurityAlert (Alerts generated by Log Analytic Rules)
- SecurityIncident (Incidents created by Microsoft Sentinel)
- AzureNetworkAnalytics_CL (malicious network traffic allowed into the honeynet)


## Architecture Before Hardening / Security Controls
![image](https://github.com/kphillip1/azure-soc-honeynet/assets/165929885/efa182b3-afe3-46d6-b431-84fe61c1daff)


## Architecture After Hardening / Security Controls
![image](https://github.com/kphillip1/azure-soc-honeynet/assets/165929885/bda2d085-3471-4d51-8373-404e5dbd3371)


The architecture of the mini honeynet in Azure consists of the following components:

- Virtual Network (VNet)
- Network Security Group (NSG)
- Virtual Machines: 2 Windows and 1 Linux
- Log Analytics Workspace
- Azure Key Vault
- Azure Storage Account
- Microsoft Sentinel
- Azure Blob Storage
- SQL Server

## Step 1: Create a Microsoft Azure Subscription: [Azure](https://azure.microsoft.com/en-us/free/)
> Free 200$ Credit for 30 days

 ![image](https://github.com/user-attachments/assets/5a97f595-81e0-4b8c-be4f-17f2ea40b684)


## Step 2: Create a Honeypot Virtual Machine
> Exposed Windows VM and Linux VM

 ![image](https://github.com/user-attachments/assets/1589ac52-842b-4f09-830c-5e0f710f41bd)


### Basics

- Go to `portal.azure.com`
- Search for "virtual machines" 
- Create > Azure virtual machine
#### Project details
- Create new resource group.
> A resource group is a collection of resources that share the same lifecycle, permissions, and policies.
#### Instance details
- Name your VM
- Select a recommended region ((US) East US 2)
- Availability options: No infrastructure redundancy required
- Security type: Standard
- Image: Windows 10 Pro, version 21H2 - x62 Gen2
- VM Architecture: x64
- Size: Default is okay (Standard_D2s_v3 â€“ 2vcpus, 8 GiB memory)
#### Administrator account
- Create a username and password for virtual machine
> IMPORTANT NOTE: These credentials will be used to log into the virtual machine (Keep them handy)
#### Inbound port rules
- Public inbound ports: Allow RDP (3389)
#### Licensing
- Confirm licensing 
- Select **Next : Disks >**


### Disks 
- Leave all defaults
- Select **Next : Networking >**

### Networking
#### Network interface
- NIC network security group: Advanced > Create new
> A network security group contains security rules that allow or deny inbound network traffic to, or outbound network traffic from, the virtual machine. In other words, security rules management.
- Remove Inbound rules (1000: default-allow-rdp) by clicking three dots
- Add an inbound rule
- Destination port ranges: * (wildcard for anything)
- Protocol: Any
- Action: Allow
- Priority: 100 (low)
- Name: Anything (ALLOW_ALL_INBOUND)
- Select **Review + create**

![image](https://github.com/user-attachments/assets/1be698f2-c684-4d95-9908-a0f1f7eba230)

> Configuring the firewall to allow traffic from anywhere will make the VM easily discoverable.

## Step 3: Instalation of SQL Server and SQL Server Management Studio (SSMS) On the windows VM

- Use RDP to connect to the Windows VM. Once connected, install SQL Server and SQL Server Management Studio (SSMS). After completing the installation, configure and connect the database to SSMS.

![image](https://github.com/user-attachments/assets/67b9e3a1-0839-42b1-a9b8-088687861338)

## Step 4: Create another Windows Vm (Hacker)

- Create another Windows VM, referred to as 'Hacker.' After its creation, simulate attacks on the Linux VM, the Windows VM, and the database hosted on SSMS.

![Screenshot 2025-01-26 154334](https://github.com/user-attachments/assets/be482b93-1c2b-4bf7-b662-feb0e44aa6e3)

## Step 5: Create a Log Analytics Workspace
- Search for "Log analytics workspaces"
- Select **Create Log Analytics workspace**
- Put it in the same resource group as VM (lab-rg)
- Give it a desired name (Project)
- Add to same region (East US 2)
- Select **Review + create**

![Screenshot 2025-01-26 154729](https://github.com/user-attachments/assets/649a3dbe-c3bd-4b1d-b4da-d75c580b207a)


> The Windows Event Viewer logs will be ingested into Log Analytics workspaces in addition to custom logs with geographic data to map attacker locations.

## Step 6: Configure Microsoft Defender for Cloud
- Search for "Microsoft Defender for Cloud"
- Scroll down to "Environment settings" > subscription name > log analytics workspace name (log-honeypot)

![Screenshot 2025-01-26 154902](https://github.com/user-attachments/assets/68a03d5e-12e8-403d-b48d-d29ccaee8337)


#### Settings | Defender plans
- Cloud Security Posture Management: ON
- Servers: ON
- SQL servers on machines: ON
- Hit **Save**

![Screenshot 2025-01-26 154919](https://github.com/user-attachments/assets/f86bd089-de15-487c-a9b8-b59a6bab95e1)


#### Settings | Data collection
- Select "All Events" 
- Hit **Save**

## Step 7: Configure Microsoft Sentinel and Create DCR rules for both Windows and Linux Vm.
- Search for "Microsoft Sentinel"
- Click **Create Microsoft Sentinel**
- Select Log Analytics workspace name (lab-rg)
- Click **Add**

![Screenshot 2025-01-26 155232](https://github.com/user-attachments/assets/7b5b1281-a557-41a5-83f1-e190ec9501f9)

## Step 8: Using Watchlist to visualize suspicious activity on a map based on the IP addresses.

- Go to Watchlist
- Click New and Give "Name", "Description" and "Alias".
- Then in the source page import the CSV File.
- Click on Review and Create.

![Screenshot 2025-01-26 160313](https://github.com/user-attachments/assets/288521fa-f4c5-47c9-8bb9-182c076b514a)

## Step 9: Map Data in Microsoft Sentinel
- Go to Microsoft Sentinel to see the Overview page and available events
- Click on **Workbooks** and **Add workbook** then click **Edit**
- Remove default widgets (Three dots > Remove)
- Click **Add > Add query** 
- Copy/Paste the following query into the query window and **Run Query**.

## Attack Maps Before Hardening / Security Controls
![image](https://github.com/user-attachments/assets/bbd55386-2520-4c73-af76-e81e1df6c45a)
<br><br>
![Screenshot 2025-01-17 093753](https://github.com/user-attachments/assets/71e68aac-a4e9-4379-8cea-246d115183e9)
<br><br>
 ![Screenshot 2025-01-17 093415](https://github.com/user-attachments/assets/e15c54a2-f89f-44a8-ad99-030238f9c19a)
<br><br>

## Metrics Before Hardening / Security Controls

The following table shows the metrics we measured in our insecure environment for 48 hours:
<br>
| Start Time 2025-01-17 11:45:07
<br>
| Stop Time 2025-01-19 11:17:03

| Metric                   | Count
| ------------------------ | -----
| SecurityEvent            | 10256
| Syslog                   | 2689
| SecurityAlert            | 4
| SecurityIncident         | 49
| AzureNetworkAnalytics_CL | 1902

## Attack Maps After Hardening / Security Controls

![Screenshot 2025-01-26 145803](https://github.com/user-attachments/assets/5baa73bb-f869-4870-b6d0-1fe003411446)


```All map queries actually returned no results due to no instances of malicious activity for the 24 hour period after hardening.```

<br><br>

## Metrics After Hardening / Security Controls

The following table shows the metrics we measured in our environment for another 24 hours, but after we have applied security controls:
<br>
| Start Time 2024-04-19 11:50:28
<br>
| Stop Time 2024-04-20 13:49:01

| Metric                   | Count
| ------------------------ | -----
| SecurityEvent            | 1627
| Syslog                   | 13
| SecurityAlert            | 0
| SecurityIncident         | 0
| AzureNetworkAnalytics_CL | 0

The tables below illustrate the differences in data before and after implementing hardening security controls, showing a significant reduction in security events and malicious activity.

![Screenshot 2025-01-26 150717](https://github.com/user-attachments/assets/1ad48cad-467d-4399-a7f9-fe24c7959e5d)

The percentage differences highlight the effectiveness of the hardened security environment in mitigating potential threats

![Screenshot 2025-01-26 150925](https://github.com/user-attachments/assets/52fd7cdf-054d-4cd4-af1b-5dffa92330da)


## Summary

In this project, a mini honeynet was built in Microsoft Azure using one Windows VM and one Linux VM configured as honeypots by modifying their NSGs. A "Hacker" VM simulated attacks on the Windows VM, which hosted SQL Server and SSMS. Logs were ingested into a Log Analytics Workspace, and Microsoft Sentinel was used to monitor, analyze, and trigger alerts based on the ingested data.

Custom workbooks and analytic rules were created to track Windows security events, Linux syslogs, and NSG malicious activity. After 24 hours of monitoring, security controls such as NSG hardening and firewalls were implemented. Post-hardening analysis revealed a significant reduction in security events and incidents, demonstrating the effectiveness of these measures in securing the environment.


## KQL Queries for Monitoring Security Metrics 

| Metric                                       | Query                                                                                                                                            |
|----------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------|
| Security Events (Windows VMs)                | SecurityEvent<br>\| where TimeGenerated>= ago(24h)<br>\| count                                                                                   |
| Syslog (Linux VMs)                           | Syslog<br>\| where TimeGenerated >= ago(24h)<br>\| count                                                                                         |
| SecurityAlert (Microsoft Defender for Cloud) | Security Alert<br>\| where DisplayName !startswith "CUSTOM" and DisplayName !startswith "TEST"<br>\| where TimeGenerated >= ago(24h)<br>\| count |
| Security Incident (Sentinel Incidents)       | SecurityIncident<br>\| where TimeGenerated >= ago(24h)<br>\| count                                                                               |
| NSG Inbound Malicious Flows Allowed          | AzureNetworkAnalytics_CL<br>\| where FlowType_s == "MaliciousFlow" and AllowedInFlows_d > 0<br>\| where TimeGenerated >= ago(24h)<br>\| count    |
